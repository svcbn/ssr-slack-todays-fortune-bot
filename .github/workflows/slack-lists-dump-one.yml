name: Slack Lists - Debug (auth + list probes)

on:
  workflow_dispatch:
    inputs:
      list_id_a:
        description: "Candidate list_id A (e.g., F0A8F387LCS)"
        required: false
        default: ""
      list_id_b:
        description: "Candidate list_id B (e.g., TKHLNPYUV)"
        required: false
        default: ""

jobs:
  debug:
    runs-on: ubuntu-latest
    steps:
      - name: Probe Slack Lists access
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          LIST_ID_SECRET: ${{ secrets.SLACK_LIST_ID }}
          LIST_ID_A: ${{ inputs.list_id_a }}
          LIST_ID_B: ${{ inputs.list_id_b }}
        run: |
          set -euo pipefail
          python3 - << 'PY'
          import os, json, urllib.request

          token = os.environ["SLACK_BOT_TOKEN"]
          list_ids = []

          # 1) Secrets에 들어있는 값도 후보로 넣고
          sec = (os.environ.get("LIST_ID_SECRET") or "").strip()
          if sec:
              list_ids.append(sec)

          # 2) workflow_dispatch inputs도 후보로 넣습니다.
          for k in ["LIST_ID_A", "LIST_ID_B"]:
              v = (os.environ.get(k) or "").strip()
              if v and v not in list_ids:
                  list_ids.append(v)

          def post(method: str, payload: dict):
              url = f"https://slack.com/api/{method}"
              data = json.dumps(payload).encode("utf-8")
              req = urllib.request.Request(url, data=data, method="POST")
              req.add_header("Authorization", f"Bearer {token}")
              req.add_header("Content-Type", "application/json; charset=utf-8")
              with urllib.request.urlopen(req, timeout=30) as resp:
                  body = resp.read().decode("utf-8")
              return json.loads(body)

          print("=== auth.test ===")
          auth = post("auth.test", {})
          print(json.dumps(auth, ensure_ascii=False, indent=2))
          print()

          if not list_ids:
              print("No list_id candidates provided. Put SLACK_LIST_ID in secrets or pass inputs.")
              raise SystemExit(0)

          print("=== list_id candidates ===")
          print(list_ids)
          print()

          # items.list probe
          for lid in list_ids:
              print(f"=== slackLists.items.list probe: list_id={lid} ===")
              res = post("slackLists.items.list", {"list_id": lid, "limit": 1})
              # ok가 아니어도 출력하고 계속
              print(json.dumps(res, ensure_ascii=False, indent=2)[:4000])
              print()

          PY
