name: Slack Lists - Find private checkbox column

on:
  workflow_dispatch:
    inputs:
      list_id:
        description: "List ID"
        required: true
        default: "F0A8F387LCS"
      limit:
        description: "Items to scan"
        required: false
        default: "200"

jobs:
  find:
    runs-on: ubuntu-latest
    steps:
      - name: Scan checkbox columns and counts
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          LIST_ID: ${{ inputs.list_id }}
          LIMIT: ${{ inputs.limit }}
        run: |
          set -euo pipefail
          python3 - << 'PY'
          import os, json, urllib.request
          from collections import defaultdict

          token = os.environ["SLACK_BOT_TOKEN"]
          list_id = os.environ["LIST_ID"]
          limit = int(os.environ.get("LIMIT","200"))
          limit = max(1, min(200, limit))

          def post(method: str, payload: dict):
              url = f"https://slack.com/api/{method}"
              data = json.dumps(payload).encode("utf-8")
              req = urllib.request.Request(url, data=data, method="POST")
              req.add_header("Authorization", f"Bearer {token}")
              req.add_header("Content-Type", "application/json; charset=utf-8")
              with urllib.request.urlopen(req, timeout=30) as resp:
                  return json.loads(resp.read().decode("utf-8"))

          res = post("slackLists.items.list", {"list_id": list_id, "limit": limit})
          if not res.get("ok"):
              raise RuntimeError(res)

          items = res.get("items", [])
          counts = defaultdict(lambda: {"true": 0, "false": 0, "null": 0})

          for it in items:
              for f in it.get("fields", []):
                  # checkbox 형태인 필드만 잡기
                  if "checkbox" in f:
                      col = f.get("column_id") or f.get("key") or "UNKNOWN"
                      # todo_completed(Col00)는 제외 후보로만 표시
                      val = f.get("checkbox")
                      if val is True:
                          counts[col]["true"] += 1
                      elif val is False:
                          counts[col]["false"] += 1
                      else:
                          counts[col]["null"] += 1

          print("items_scanned =", len(items))
          print("=== checkbox column counts (column_id -> true/false) ===")
          print(json.dumps(counts, ensure_ascii=False, indent=2))

          # 후보 추천: Col00 제외 + true가 존재하는 checkbox 컬럼
          candidates = []
          for col, c in counts.items():
              if col == "Col00":
                  continue
              if c["true"] > 0:
                  candidates.append((col, c["true"], c["false"], c["null"]))
          candidates.sort(key=lambda x: (-x[1], x[0]))

          print("\n=== candidates (excluding Col00, true>0) ===")
          for col, t, f, n in candidates:
              print(f"- {col}: true={t} false={f} null={n}")
          PY
